<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç”Ÿæ´»åµæ¢äº‹å‹™æ‰€ï¼šæˆèªè§£å¯†</title>
    
    <!-- Core Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Styling & Animations -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            overflow: hidden; /* Prevent scrolling on mobile drag */
            touch-action: none;
        }
        
        /* Custom Scrollbar for Settings */
        .settings-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .settings-scroll::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }

        /* Holographic FAB Effect */
        .holo-fab {
            background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0.1) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            animation: holoShimmer 3s infinite linear;
            background-size: 200% 200%;
        }

        @keyframes holoShimmer {
            0% { background-position: 0% 50%; border-color: rgba(255,255,255,0.4); }
            50% { background-position: 100% 50%; border-color: rgba(100,200,255,0.6); }
            100% { background-position: 0% 50%; border-color: rgba(255,255,255,0.4); }
        }

        /* Grid Selection Highlight */
        .grid-cell-selected {
            background-color: #f59e0b; /* Amber-500 */
            color: white;
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .grid-cell-found {
            background-color: #10b981; /* Emerald-500 */
            color: white;
            animation: pulseSuccess 0.5s ease-in-out;
        }

        .shake-animation {
            animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes pulseSuccess {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'detective': {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a', // Main dark theme
                        },
                        'paper': '#fefce8', // Yellowish paper
                        'accent': '#f59e0b', // Amber
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-detective-50 text-detective-900 select-none">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const { motion, AnimatePresence } = window.Motion;
        
        // --- Game Data & Config ---
        
        const VOCAB_DATA = [
            { word: "æŠ½å±œ", hint: "æ¡Œå­çš„ä¸€éƒ¨åˆ†ï¼Œå¯ä»¥æ‹‰é–‹ä¾†æ”¾æ±è¥¿ã€‚", type: "visual", icon: "ğŸ—„ï¸" },
            { word: "æ‰“è½‰", hint: "ä¸€ç›´åœ¨åŸåœ°ç¹åœˆåœˆï¼Œæ²’æœ‰åœä¸‹ä¾†ã€‚", type: "visual", icon: "ğŸŒ€" },
            { word: "æ¿ƒ", hint: "å‘³é“å¾ˆé‡ï¼Œæˆ–æ˜¯é¡è‰²å¾ˆæ·±ï¼Œåƒå¾ˆé»‘çš„å’–å•¡ã€‚", type: "visual", icon: "â˜•" },
            { word: "ç™®", hint: "å¾ˆå–œæ­¡åšä¸€ä»¶äº‹ï¼Œä¸åšæœƒè¦ºå¾—å…¨èº«ä¸èˆ’æœã€‚", type: "visual", icon: "ğŸ®" },
            { word: "åé›²åéœ§", hint: "å½¢å®¹æŠ½ç…™æˆ–å¤©æ°£æœ‰éœ§çš„æ¨£å­ã€‚", type: "assoc", icon: "ğŸŒ«ï¸" },
            { word: "æ‰“è³­", hint: "å…©å€‹äººçŒœæ¸¬çµæœï¼Œè¼¸çš„äººè¦æ¥å—è™•ç½°ã€‚", type: "assoc", icon: "ğŸ¤" },
            { word: "ç›¡æƒ…", hint: "å¾ˆé–‹å¿ƒåœ°å»åšï¼Œå®Œå…¨ä¸ä¿ç•™ã€‚", type: "assoc", icon: "ğŸ¥³" },
            { word: "ä¸ç´„è€ŒåŒ", hint: "æ²’æœ‰äº‹å…ˆè¬›å¥½ï¼Œçµæœåšäº†ä¸€æ¨£çš„äº‹ã€‚", type: "assoc", icon: "ğŸ‘¯" },
            { word: "æ‚ æ‚ ", hint: "å½¢å®¹æ™‚é–“å¾ˆé•·ï¼Œæˆ–æ˜¯å‹•ä½œæ…¢æ…¢çš„æ¨£å­ã€‚", type: "context", icon: "â³" },
            { word: "ä¿¡ç”¨", hint: "èªªè©±ç®—è©±ï¼Œç­”æ‡‰çš„äº‹ä¸€å®šåšåˆ°ã€‚", type: "context", icon: "ğŸ›¡ï¸" },
            { word: "çè—", hint: "æŠŠæœ€å¯¶è²´çš„æ±è¥¿å¥½å¥½æ”¶èµ·ä¾†ã€‚", type: "context", icon: "ğŸ’" },
        ];

        // --- Helper Functions ---

        const getGridSize = (level) => {
            switch(level) {
                case 'easy': return 5;
                case 'medium': return 6;
                case 'high': return 8;
                default: return 6;
            }
        };

        const generateGrid = (targetWord, level) => {
            const gridSize = getGridSize(level);
            const grid = Array(gridSize).fill(null).map(() => Array(gridSize).fill(''));
            const directions = [[0, 1], [1, 0]]; // Horizontal, Vertical only
            const dir = directions[Math.floor(Math.random() * directions.length)];
            
            // Placement Logic
            let placed = false;
            let attempts = 0;
            while (!placed && attempts < 100) {
                const row = Math.floor(Math.random() * gridSize);
                const col = Math.floor(Math.random() * gridSize);
                
                if (row + dir[0] * targetWord.length <= gridSize && 
                    col + dir[1] * targetWord.length <= gridSize) {
                    
                    for (let i = 0; i < targetWord.length; i++) {
                        grid[row + dir[0] * i][col + dir[1] * i] = targetWord[i];
                    }
                    placed = true;
                }
                attempts++;
            }

            if (!placed) {
                for (let i = 0; i < targetWord.length; i++) {
                    if (i < gridSize) grid[0][i] = targetWord[i];
                }
            }

            // Distractor Logic
            const baseChars = "ä¸ç´„è€ŒåŒåé›²åéœ§æ‚ æ‚ ä¿¡ç”¨æ‰“è³­çè—ç›¡æƒ…æ¿ƒç™®æŠ½å±œä¸Šä¸‹å·¦å³å¿ƒæƒ…å¿«æ¨‚å¤©æ°£ç¾å¥½å…‰é™°ä¼¼ç®­æ—¥æœˆå¦‚æ¢­ä¸€å¿ƒä¸€æ„äº”èŠ±å…«é–€ä¸ƒä¸Šå…«ä¸‹";
            
            // For High level, include some similar chars or parts of the word to increase difficulty
            // For Easy/Medium, strictly filter out target chars
            let validChars;
            if (level === 'high') {
                validChars = baseChars.split(''); // Include everything
            } else {
                const targetSet = new Set(targetWord.split(''));
                validChars = baseChars.split('').filter(c => !targetSet.has(c));
            }

            for (let r = 0; r < gridSize; r++) {
                for (let c = 0; c < gridSize; c++) {
                    if (grid[r][c] === '') {
                        grid[r][c] = validChars[Math.floor(Math.random() * validChars.length)];
                    }
                }
            }
            return grid;
        };

        const speak = (text, rate = 1.0, enabled = true) => {
            if (!enabled || !window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-HK';
            utterance.rate = rate;
            window.speechSynthesis.speak(utterance);
        };

        const playSound = (type) => {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            const ctx = new AudioContext();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);

            const now = ctx.currentTime;
            if (type === 'success') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(500, now);
                osc.frequency.exponentialRampToValueAtTime(1000, now + 0.1);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                osc.start(now);
                osc.stop(now + 0.5);
            } else if (type === 'tap') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(300, now);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            } else if (type === 'error') {
                 osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            }
        };

        // --- Components ---

        const Icon = ({ name, size = 24, className }) => {
            React.useEffect(() => {
                lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        const SettingsPanel = ({ isOpen, onClose, settings, setSettings }) => {
            return (
                <AnimatePresence>
                    {isOpen && (
                        <>
                            <motion.div 
                                initial={{ opacity: 0 }} animate={{ opacity: 0.5 }} exit={{ opacity: 0 }}
                                className="fixed inset-0 bg-black z-40"
                                onClick={onClose}
                            />
                            <motion.div
                                initial={{ x: '100%' }} animate={{ x: 0 }} exit={{ x: '100%' }}
                                transition={{ type: "spring", damping: 25, stiffness: 200 }}
                                className="fixed right-0 top-0 bottom-0 w-80 bg-detective-50 border-l border-detective-200 shadow-2xl z-50 p-6 flex flex-col"
                            >
                                <div className="flex justify-between items-center mb-8">
                                    <h2 className="text-2xl font-bold text-detective-800 flex items-center gap-2">
                                        <Icon name="settings" /> è¨­å®š
                                    </h2>
                                    <button onClick={onClose} className="p-2 bg-detective-200 rounded-full hover:bg-detective-300">
                                        <Icon name="x" />
                                    </button>
                                </div>

                                <div className="mb-8 overflow-y-auto max-h-[60vh] settings-scroll pr-2">
                                    <div className="mb-8">
                                        <h3 className="text-lg font-bold text-detective-700 mb-4 flex items-center gap-2">
                                            <Icon name="type" /> å­—é«”å¤§å°
                                        </h3>
                                        <div className="space-y-3">
                                            {[14, 16, 18, 22, 26, 32].map(size => (
                                                <button
                                                    key={size}
                                                    onClick={() => setSettings(s => ({...s, fontSize: size}))}
                                                    className={`w-full p-3 rounded-lg flex items-center justify-between transition-colors ${
                                                        settings.fontSize === size 
                                                            ? 'bg-indigo-600 text-white shadow-lg' 
                                                            : 'bg-white border border-detective-200 text-detective-600'
                                                    }`}
                                                >
                                                    <span style={{ fontSize: `${size}px` }}>
                                                        {size === 14 ? "å°å°çš„" : 
                                                         size === 16 ? "å°ä¸€é»" :
                                                         size === 18 ? "å‰›å‰›å¥½" :
                                                         size === 22 ? "å¤§ä¸€é»" :
                                                         size === 26 ? "å¤§å¤§çš„" : "è¶…ï½å¤§"}
                                                    </span>
                                                    {settings.fontSize === size && <Icon name="check" size={16} />}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="mb-8">
                                        <h3 className="text-lg font-bold text-detective-700 mb-4 flex items-center gap-2">
                                            <Icon name="mic" /> èªªè©±é€Ÿåº¦
                                        </h3>
                                        <div className="bg-white p-4 rounded-xl border border-detective-200">
                                            <div className="flex justify-between text-2xl mb-2">
                                                <span>ğŸ¢</span>
                                                <span>ğŸ‡</span>
                                            </div>
                                            <input 
                                                type="range" 
                                                min="0.5" max="1.0" step="0.1"
                                                value={settings.speechRate}
                                                onChange={(e) => setSettings(s => ({...s, speechRate: parseFloat(e.target.value)}))}
                                                className="w-full h-2 bg-detective-200 rounded-lg appearance-none cursor-pointer accent-indigo-600"
                                            />
                                            <div className="text-center mt-2 font-mono text-detective-500">
                                                {settings.speechRate}x
                                            </div>
                                        </div>
                                    </div>

                                    <div className="flex items-center justify-between p-4 bg-white rounded-xl border border-detective-200">
                                        <span className="font-bold text-detective-700">èªéŸ³é–‹é—œ</span>
                                        <button 
                                            onClick={() => setSettings(s => ({...s, soundEnabled: !s.soundEnabled}))}
                                            className={`w-14 h-8 rounded-full p-1 transition-colors ${settings.soundEnabled ? 'bg-green-500' : 'bg-gray-300'}`}
                                        >
                                            <div className={`w-6 h-6 bg-white rounded-full shadow-md transform transition-transform ${settings.soundEnabled ? 'translate-x-6' : ''}`} />
                                        </button>
                                    </div>
                                </div>
                            </motion.div>
                        </>
                    )}
                </AnimatePresence>
            );
        };

        const Grid = ({ letters, targetWord, onFound, settings, level }) => {
            const [selected, setSelected] = useState([]);
            // Use ref to track selection immediately without waiting for render cycle
            // This fixes the issue where fast dragging causes lost frames/events
            const selectionRef = useRef([]);
            const [isSelecting, setIsSelecting] = useState(false);
            const [foundCells, setFoundCells] = useState([]);
            const [shakeError, setShakeError] = useState(false);

            const gridSize = getGridSize(level);
            const gridStyle = {
                gridTemplateColumns: `repeat(${gridSize}, minmax(0, 1fr))`
            };

            const handleStart = (r, c) => {
                setIsSelecting(true);
                const startNode = {r, c};
                setSelected([startNode]);
                selectionRef.current = [startNode]; // Sync ref
                playSound('tap');
                setShakeError(false);
            };

            const handleMove = (r, c) => {
                if (!isSelecting) return;
                
                // Get current path from ref for immediate logic
                const currentPath = selectionRef.current;
                const last = currentPath[currentPath.length - 1];
                
                // 1. Check if same cell (ignore micro-movements)
                if (last.r === r && last.c === c) return;

                // 2. BACKTRACKING LOGIC (Allow user to undo by moving back)
                if (currentPath.length >= 2) {
                    const prev = currentPath[currentPath.length - 2];
                    if (prev.r === r && prev.c === c) {
                        // User moved back to previous cell, pop the last one
                        const newPath = currentPath.slice(0, -1);
                        selectionRef.current = newPath;
                        setSelected(newPath);
                        playSound('tap'); // Feedback for undo
                        return;
                    }
                }

                // 3. Neighbor Check (Must be adjacent including diagonal if we allowed it, but here strict adjacency)
                if (Math.abs(last.r - r) <= 1 && Math.abs(last.c - c) <= 1) {
                    
                    // Prevent looping (already in path)
                    if (currentPath.some(cell => cell.r === r && cell.c === c)) return;

                    // 4. VECTOR LOCKING (Strict Linear)
                    let isValid = false;

                    if (currentPath.length === 1) {
                        // Second point determines direction (Horizontal or Vertical only)
                        if (r === last.r || c === last.c) {
                            isValid = true;
                        }
                    } else {
                        // Third+ point must follow established vector
                        const dRow = currentPath[1].r - currentPath[0].r;
                        const dCol = currentPath[1].c - currentPath[0].c;
                        
                        if ((r - last.r) === dRow && (c - last.c) === dCol) {
                            isValid = true;
                        }
                    }

                    if (isValid) {
                        const newPath = [...currentPath, {r, c}];
                        selectionRef.current = newPath; // Update ref immediately
                        setSelected(newPath); // Update state for render
                        playSound('tap');
                    } else {
                        // Invalid move (e.g. turning corner) - Optional feedback here?
                    }
                }
            };

            const handleEnd = () => {
                setIsSelecting(false);
                const currentPath = selectionRef.current;
                const word = currentPath.map(cell => letters[cell.r][cell.c]).join('');
                
                if (word === targetWord) {
                    playSound('success');
                    setFoundCells(currentPath);
                    onFound();
                } else {
                    if (currentPath.length > 0) {
                        playSound('error');
                        setShakeError(true);
                        // Clear after animation
                        setTimeout(() => {
                            setShakeError(false);
                            setSelected([]);
                            selectionRef.current = [];
                        }, 500);
                        return; // Don't clear immediately to show error
                    }
                }
                setSelected([]);
                selectionRef.current = [];
            };

            return (
                <div 
                    className={`grid gap-1 p-2 bg-white rounded-xl border-2 border-detective-300 shadow-inner select-none touch-none w-full max-w-[500px] mx-auto ${shakeError ? 'shake-animation' : ''}`}
                    style={gridStyle}
                    onPointerLeave={handleEnd}
                    onPointerUp={handleEnd}
                >
                    {letters.map((row, r) => (
                        row.map((char, c) => {
                            const isSelected = selected.some(cell => cell.r === r && cell.c === c);
                            const isFound = foundCells.some(cell => cell.r === r && cell.c === c);
                            
                            // Visual feedback for error state on selected cells
                            const isError = shakeError && isSelected;

                            return (
                                <motion.div
                                    key={`${r}-${c}`}
                                    className={`
                                        aspect-square flex items-center justify-center font-bold rounded-lg cursor-pointer transition-colors duration-75
                                        ${isError ? 'bg-red-500 text-white' : 
                                          isSelected ? 'grid-cell-selected' : 
                                          isFound ? 'grid-cell-found' : 
                                          'bg-detective-50 text-detective-600 hover:bg-detective-100'}
                                    `}
                                    style={{ fontSize: `${settings.fontSize + (level === 'easy' ? 4 : 2)}px` }}
                                    onPointerDown={(e) => {
                                        e.target.releasePointerCapture(e.pointerId);
                                        handleStart(r, c);
                                    }}
                                    onPointerEnter={() => handleMove(r, c)}
                                >
                                    {char}
                                </motion.div>
                            )
                        })
                    ))}
                </div>
            );
        };

        const GameScreen = ({ level, onBack, onComplete, settings }) => {
            const [currentQuestionIdx, setCurrentQuestionIdx] = useState(0);
            const [gridLetters, setGridLetters] = useState([]);
            const [showHint, setShowHint] = useState(0); 
            
            const questions = useMemo(() => {
                let types = [];
                if (level === 'easy') types = ['visual'];
                else if (level === 'medium') types = ['assoc'];
                else types = ['context'];
                return VOCAB_DATA.filter(q => types.includes(q.type));
            }, [level]);

            const currentQ = questions[currentQuestionIdx];

            useEffect(() => {
                if (currentQ) {
                    setGridLetters(generateGrid(currentQ.word, level));
                    setShowHint(0);
                    speak(`è«‹æ‰¾å‡ºï¼š${currentQ.word}`, settings.speechRate, settings.soundEnabled);
                }
            }, [currentQuestionIdx, currentQ, settings, level]);

            const handleFound = () => {
                speak("å¤ªæ£’äº†ï¼æ‰¾åˆ°äº†ï¼", settings.speechRate, settings.soundEnabled);
                setTimeout(() => {
                    if (currentQuestionIdx < questions.length - 1) {
                        setCurrentQuestionIdx(prev => prev + 1);
                    } else {
                        onComplete(questions.length); 
                    }
                }, 1500);
            };

            const toggleHint = () => {
                setShowHint(prev => Math.min(prev + 1, 2));
                if (showHint === 0) speak("è©¦è©¦çœ‹æ‰¾é€™å€‹å­—é–‹é ­", settings.speechRate, settings.soundEnabled);
            };

            if (!currentQ) return <div>Loading...</div>;

            return (
                <div className="flex flex-col h-full relative overflow-hidden">
                    {/* Top Bar */}
                    <div className="flex justify-between items-center p-4 bg-white border-b border-detective-200 shadow-sm z-20 shrink-0">
                        <button onClick={onBack} className="flex items-center gap-2 text-detective-600 font-bold hover:bg-detective-100 px-3 py-1 rounded-lg">
                            <Icon name="arrow-left" /> è¿”å›
                        </button>
                        <div className="text-xl font-bold text-detective-800">
                             åµæ¢é€²åº¦ {currentQuestionIdx + 1} / {questions.length}
                        </div>
                        <button onClick={toggleHint} className="bg-yellow-100 text-yellow-700 p-2 rounded-full hover:bg-yellow-200">
                            <Icon name="lightbulb" />
                        </button>
                    </div>

                    {/* Main Content: Split View for Desktop, Column for Mobile */}
                    <div className="flex-1 flex flex-col md:flex-row overflow-hidden relative">
                        
                        {/* Left/Top: Scene & Question */}
                        <div className="flex-1 bg-detective-100 relative flex flex-col items-center justify-center p-4 md:p-8 overflow-y-auto">
                             <div className="absolute top-10 left-10 opacity-10 pointer-events-none"><Icon name="file-search" size={100} /></div>
                            
                            <motion.div 
                                key={currentQ.word}
                                initial={{ scale: 0.8, opacity: 0 }}
                                animate={{ scale: 1, opacity: 1 }}
                                className="bg-white p-6 rounded-2xl shadow-xl w-full max-w-2xl text-center border-t-4 border-indigo-500 relative z-10 my-auto"
                            >
                                <div className="text-6xl mb-4">{currentQ.icon}</div>
                                
                                {level === 'easy' && (
                                    <h2 className="font-black text-indigo-600 mb-2 leading-tight" style={{ fontSize: `${settings.fontSize + 10}px` }}>
                                        {currentQ.word}
                                    </h2>
                                )}

                                {(level === 'medium' || level === 'high') && (
                                    <h2 className="font-bold text-detective-800 mb-2 leading-tight" style={{ fontSize: `${settings.fontSize + 4}px` }}>
                                        {level === 'medium' ? "é€™æ˜¯ä»€éº¼æˆèªï¼Ÿ" : "å¡«å¡«çœ‹ï¼š"}
                                    </h2>
                                )}

                                <p className="text-detective-600 mt-2 leading-relaxed" style={{ fontSize: `${settings.fontSize}px` }}>
                                    {currentQ.hint}
                                </p>

                                {showHint >= 2 && (
                                    <motion.div initial={{opacity:0}} animate={{opacity:1}} className="mt-4 p-2 bg-green-100 text-green-700 rounded-lg">
                                        ç­”æ¡ˆæ˜¯ï¼š{currentQ.word}
                                    </motion.div>
                                )}
                            </motion.div>
                        </div>

                        {/* Right/Bottom: Grid */}
                        <div className="bg-detective-50 p-4 md:p-8 shadow-[0_-4px_20px_rgba(0,0,0,0.05)] md:shadow-[-4px_0_20px_rgba(0,0,0,0.05)] rounded-t-3xl md:rounded-t-none md:rounded-l-3xl z-10 shrink-0 md:w-[50%] lg:w-[45%] flex flex-col justify-center relative overflow-y-auto">
                             <div className="w-full max-w-lg mx-auto">
                                <div className="flex justify-between mb-4 px-2">
                                    <span className="text-sm text-detective-400 font-bold uppercase tracking-widest">
                                        CIPHER TEXT - LEVEL: {level.toUpperCase()}
                                    </span>
                                    <button onClick={() => speak(currentQ.word, 0.7, settings.soundEnabled)} className="text-indigo-500 hover:bg-indigo-50 p-1 rounded">
                                        <Icon name="volume-2" />
                                    </button>
                                </div>
                                <Grid 
                                    letters={gridLetters} 
                                    targetWord={currentQ.word} 
                                    onFound={handleFound}
                                    settings={settings}
                                    level={level}
                                />
                             </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ReportScreen = ({ score, onRestart, onHome, settings }) => {
            return (
                <div className="h-full flex flex-col items-center justify-center bg-paper p-6 text-center overflow-y-auto">
                    <motion.div 
                        initial={{ scale: 0 }} animate={{ scale: 1 }}
                        className="bg-white p-8 rounded-3xl shadow-2xl max-w-2xl w-full border-4 border-detective-800 my-auto"
                    >
                        <div className="text-6xl mb-4">ğŸ‰</div>
                        <h1 className="text-3xl font-black text-detective-900 mb-4">æ¡ˆä»¶èª¿æŸ¥å ±å‘Š</h1>
                        
                        <div className="bg-detective-100 p-4 rounded-xl mb-6">
                            <p className="text-detective-600 font-bold mb-2">æœ¬æ¬¡æœæŸ¥çµæœ</p>
                            <div className="text-5xl font-black text-indigo-600">{score} <span className="text-2xl text-detective-400">åˆ†</span></div>
                        </div>

                        <div className="space-y-4 mb-8 text-left">
                            <div className="flex items-start gap-3">
                                <div className="bg-green-100 p-2 rounded-full text-green-600"><Icon name="check-circle" /></div>
                                <div>
                                    <h4 className="font-bold text-detective-800">æœæŸ¥å°ˆå®¶</h4>
                                    <p className="text-sm text-detective-500">ä½ å°æ–¼ã€Œæ‰¾å­—ã€éå¸¸æ•éŠ³ï¼Œçœ¼ç›å¾ˆåˆ©å–”ï¼</p>
                                </div>
                            </div>
                             <div className="flex items-start gap-3">
                                <div className="bg-amber-100 p-2 rounded-full text-amber-600"><Icon name="trending-up" /></div>
                                <div>
                                    <h4 className="font-bold text-detective-800">å»ºè­°è¡Œå‹•</h4>
                                    <p className="text-sm text-detective-500">ä¸‹æ¬¡è©¦è©¦çœ‹æŒ‘æˆ°æ›´é›£çš„ã€Œç·šç´¢ã€æ¨¡å¼ï¼Ÿ</p>
                                </div>
                            </div>
                        </div>

                        <div className="flex gap-4 flex-col sm:flex-row">
                            <button onClick={onHome} className="flex-1 py-3 bg-detective-200 text-detective-700 font-bold rounded-xl hover:bg-detective-300 transition">
                                å›é¦–é 
                            </button>
                            <button onClick={onRestart} className="flex-1 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition">
                                å†ç©ä¸€æ¬¡
                            </button>
                        </div>
                    </motion.div>
                </div>
            );
        };

        const App = () => {
            const [screen, setScreen] = useState('home'); // home, game, report
            const [level, setLevel] = useState('easy');
            const [showSettings, setShowSettings] = useState(false);
            const [score, setScore] = useState(0);
            const [settings, setSettings] = useState({
                fontSize: 18,
                speechRate: 1.0,
                soundEnabled: true
            });

            // Handle HTML Download
            const handleDownload = () => {
                const htmlContent = document.documentElement.outerHTML;
                const blob = new Blob([htmlContent], {type: 'text/html'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ç”Ÿæ´»åµæ¢äº‹å‹™æ‰€_å‚™ä»½.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };

            return (
                <div className="h-screen w-full overflow-hidden flex flex-col relative bg-detective-50" style={{ fontSize: `${settings.fontSize}px` }}>
                    
                    {/* Settings Button (Global) */}
                    <button 
                        onClick={() => setShowSettings(true)}
                        className="fixed top-4 right-4 z-50 bg-indigo-600 text-white p-3 rounded-xl shadow-lg hover:bg-indigo-700 transition-transform hover:scale-105"
                    >
                        <Icon name="sliders-horizontal" />
                    </button>

                    <SettingsPanel 
                        isOpen={showSettings} 
                        onClose={() => setShowSettings(false)}
                        settings={settings}
                        setSettings={setSettings}
                    />

                    {/* Screens */}
                    <AnimatePresence mode="wait">
                        {screen === 'home' && (
                            <motion.div 
                                key="home"
                                initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0, x: -100 }}
                                className="flex-1 flex flex-col items-center justify-center p-6 bg-detective-50 relative overflow-y-auto"
                            >
                                <div className="text-center max-w-3xl w-full my-auto">
                                    <div className="mb-6 inline-block p-4 bg-white rounded-full shadow-xl">
                                        <Icon name="search" size={64} className="text-indigo-600" />
                                    </div>
                                    <h1 className="text-4xl md:text-5xl font-black text-detective-900 mb-2 tracking-tight">
                                        ç”Ÿæ´»åµæ¢äº‹å‹™æ‰€
                                    </h1>
                                    <p className="text-xl text-detective-500 mb-10 font-medium">
                                        å°‹æ‰¾éš±è—çš„ç·šç´¢ï¼Œè§£é–‹æˆèªçš„ç§˜å¯†
                                    </p>

                                    {/* Name Input Mockup */}
                                    <div className="bg-white p-2 rounded-2xl shadow-sm border border-detective-200 max-w-md mx-auto mb-8 flex">
                                        <div className="bg-detective-100 px-4 py-2 rounded-xl flex items-center justify-center font-bold text-detective-500 whitespace-nowrap">
                                            åµæ¢ä»£è™Ÿ
                                        </div>
                                        <input type="text" placeholder="è¼¸å…¥åå­—..." className="flex-1 px-4 outline-none bg-transparent min-w-0" />
                                    </div>

                                    {/* Level Selection */}
                                    <div className="grid gap-4 max-w-4xl mx-auto md:grid-cols-3">
                                        <button onClick={() => { setLevel('easy'); setScreen('game'); }} className="group relative overflow-hidden bg-white p-6 rounded-2xl border-2 border-green-200 hover:border-green-500 transition-all text-left shadow-sm hover:shadow-md flex flex-col justify-between h-full">
                                            <div className="bg-green-100 p-3 rounded-xl text-green-600 font-bold text-xl w-fit mb-4">ğŸŸ¢</div>
                                            <div>
                                                <h3 className="font-bold text-lg text-detective-800 mb-2">åˆç´šæ¡ˆä»¶ï¼š<br/>çœ¼åŠ›å¤§è€ƒé©—</h3>
                                                <p className="text-sm text-detective-500">5x5 å­—ç›¤<br/>ç›´æ¥æ‰¾å‡ºçœ‹åˆ°çš„è©å½™</p>
                                            </div>
                                            <div className="mt-4 flex justify-end">
                                                <Icon name="chevron-right" className="text-detective-300 group-hover:text-green-500" />
                                            </div>
                                        </button>

                                        <button onClick={() => { setLevel('medium'); setScreen('game'); }} className="group relative overflow-hidden bg-white p-6 rounded-2xl border-2 border-yellow-200 hover:border-yellow-500 transition-all text-left shadow-sm hover:shadow-md flex flex-col justify-between h-full">
                                            <div className="bg-yellow-100 p-3 rounded-xl text-yellow-600 font-bold text-xl w-fit mb-4">ğŸŸ¡</div>
                                            <div>
                                                <h3 className="font-bold text-lg text-detective-800 mb-2">ä¸­ç´šæ¡ˆä»¶ï¼š<br/>ç·šç´¢è¯æƒ³</h3>
                                                <p className="text-sm text-detective-500">6x6 å­—ç›¤<br/>çœ‹åœ–ç‰‡çŒœçŒœçœ‹</p>
                                            </div>
                                            <div className="mt-4 flex justify-end">
                                                 <Icon name="chevron-right" className="text-detective-300 group-hover:text-yellow-500" />
                                            </div>
                                        </button>

                                        <button onClick={() => { setLevel('high'); setScreen('game'); }} className="group relative overflow-hidden bg-white p-6 rounded-2xl border-2 border-red-200 hover:border-red-500 transition-all text-left shadow-sm hover:shadow-md flex flex-col justify-between h-full">
                                            <div className="bg-red-100 p-3 rounded-xl text-red-600 font-bold text-xl w-fit mb-4">ğŸ”´</div>
                                            <div>
                                                <h3 className="font-bold text-lg text-detective-800 mb-2">é«˜ç´šæ¡ˆä»¶ï¼š<br/>å¯†ç¢¼è§£è®€</h3>
                                                <p className="text-sm text-detective-500">8x8 å­—ç›¤<br/>è®€å¥å­å¡«ç©º</p>
                                            </div>
                                            <div className="mt-4 flex justify-end">
                                                 <Icon name="chevron-right" className="text-detective-300 group-hover:text-red-500" />
                                            </div>
                                        </button>
                                    </div>
                                    
                                    {/* Download Button */}
                                    <button 
                                        onClick={handleDownload}
                                        className="mt-12 flex items-center gap-2 text-detective-400 hover:text-detective-600 text-sm mx-auto transition-colors"
                                    >
                                        <Icon name="download" size={16} /> ä¸‹è¼‰æœ¬é  HTML (å‚™ä»½ç”¨)
                                    </button>
                                </div>
                            </motion.div>
                        )}

                        {screen === 'game' && (
                            <motion.div 
                                key="game"
                                initial={{ opacity: 0, x: 100 }} animate={{ opacity: 1, x: 0 }} exit={{ opacity: 0, x: -100 }}
                                className="h-full w-full"
                            >
                                <GameScreen 
                                    level={level} 
                                    settings={settings}
                                    onBack={() => setScreen('home')}
                                    onComplete={(finalScore) => { setScore(finalScore * 100); setScreen('report'); }}
                                />
                            </motion.div>
                        )}

                        {screen === 'report' && (
                            <motion.div 
                                key="report"
                                initial={{ opacity: 0, scale: 0.8 }} animate={{ opacity: 1, scale: 1 }} exit={{ opacity: 0 }}
                                className="h-full w-full"
                            >
                                <ReportScreen 
                                    score={score} 
                                    settings={settings}
                                    onRestart={() => setScreen('game')}
                                    onHome={() => setScreen('home')}
                                />
                            </motion.div>
                        )}
                    </AnimatePresence>

                    {/* Footer */}
                    <div className="fixed bottom-0 w-full text-center py-2 text-xs text-detective-400 bg-detective-50/80 backdrop-blur-sm pointer-events-none z-0">
                        Â©2025 WMC
                    </div>

                    {/* Holographic FAB */}
                    <div className="holo-fab fixed bottom-6 right-6 px-4 py-2 rounded-full flex items-center gap-2 cursor-pointer z-50 select-none hover:scale-105 transition-transform">
                        <Icon name="monitor" size={16} className="text-indigo-500" />
                        <span className="font-bold text-xs bg-clip-text text-transparent bg-gradient-to-r from-indigo-500 to-purple-600">
                            WMC é»ƒè€å¸« è¨­è¨ˆ
                        </span>
                    </div>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
